<!DOCTYPE html>
<html lang="en" class="light-theme">
<head>
  <meta charset="UTF-8" />
  <title>Workout Tracker Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --card: #f4f4f5;
      --border: #e4e4e7;
      --accent: #111111;
      --accent-soft: #27272a;
      --accent-text: #ffffff;
      --muted: #71717a;
      --danger: #dc2626;
      --nav-bg: #f4f4f5;
    }

    body.dark-theme {
      --bg: #0b0b0c;
      --text: #f4f4f5;
      --card: #18181b;
      --border: #27272a;
      --accent: #f4f4f5;
      --accent-soft: #27272a;
      --accent-text: #0b0b0c;
      --muted: #a1a1aa;
      --danger: #f97373;
      --nav-bg: #111111;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.25s ease, color 0.25s ease;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding-bottom: 80px; /* space for bottom timer bar */
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background-color: var(--nav-bg);
      border-bottom: 1px solid var(--border);
    }

    .top-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
    }

    .nav-tabs {
      display: flex;
      gap: 16px;
      font-size: 0.9rem;
      flex-wrap: wrap;
    }

    .nav-tab {
      cursor: pointer;
      padding-bottom: 4px;
      border-bottom: 2px solid transparent;
      color: var(--muted);
    }

    .nav-tab.active {
      color: var(--text);
      border-bottom-color: var(--accent);
      font-weight: 600;
    }

    .theme-toggle-btn {
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 1.1rem;
    }

    .summary-bar {
      display: none;
      padding: 8px 16px 10px;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      background-color: var(--bg);
    }

    .summary-bar.active {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .summary-left {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 0.85rem;
    }

    .summary-label {
      font-weight: 600;
    }

    .summary-stat span {
      font-weight: 500;
    }

    .summary-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: var(--card);
      color: var(--text);
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .btn-primary {
      background-color: var(--accent);
      color: var(--accent-text);
      border-color: var(--accent);
    }

    .btn-danger {
      border-color: var(--danger);
      color: var(--danger);
      background-color: transparent;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 0.75rem;
    }

    main {
      padding: 12px 16px 24px;
    }

    .main-tab {
      display: none;
    }

    .main-tab.active {
      display: block;
    }

    .start-workout-wrapper {
      margin-bottom: 12px;
    }

    .day-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      border-radius: 999px;
      background-color: var(--card);
      padding: 4px;
    }

    .day-tab {
      flex: 1;
      text-align: center;
      padding: 6px 0;
      font-size: 0.85rem;
      cursor: pointer;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
    }

    .day-tab.active {
      background-color: var(--accent-soft);
      color: var(--accent-text);
      font-weight: 600;
    }

    /* improve contrast for active day tab in dark mode */
    body.dark-theme .day-tab.active {
      background-color: #3b82f6;
      color: #ffffff;
    }

    .day-panel {
      display: none;
    }

    .day-panel.active {
      display: block;
    }

    .exercise-list {
      margin-top: 8px;
    }

    .exercise-card {
      background-color: var(--card);
      border-radius: 10px;
      padding: 10px 10px 8px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      cursor: grab;
      transition: background-color 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease, max-height 0.25s ease;
      position: relative;
    }

    .exercise-card.dragging {
      opacity: 0.6;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
    }

    .exercise-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .exercise-title {
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .exercise-title .collapse-icon {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .exercise-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .drag-handle {
      font-size: 1.1rem;
      cursor: grab;
      color: var(--muted);
    }

    .exercise-menu-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1rem;
      color: var(--muted);
      padding: 0 4px;
    }

    .exercise-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.75rem;
      margin-bottom: 6px;
      color: var(--muted);
    }

    .exercise-stats span strong {
      color: var(--text);
    }

    .exercise-body {
      overflow: hidden;
      transition: max-height 0.25s ease, opacity 0.2s ease;
    }

    .exercise-card.collapsed .exercise-body {
      max-height: 0;
      opacity: 0;
      pointer-events: none;
    }

    .exercise-card:not(.collapsed) .exercise-body {
      max-height: 600px; /* enough for sets + history */
      opacity: 1;
    }

    .sets-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .sets-table th,
    .sets-table td {
      padding: 3px 4px;
      text-align: left;
    }

    .sets-table th {
      font-weight: 500;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .sets-table td input {
      width: 100%;
      padding: 3px 4px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: var(--bg);
      color: var(--text);
      font-size: 0.8rem;
    }

    .sets-table tr.completed td {
      opacity: 0.9;
    }

    .set-done-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: var(--bg);
      padding: 3px 10px;
      font-size: 0.7rem;
      cursor: pointer;
    }

    .set-done-btn.done {
      background-color: #16a34a !important;
      border-color: #16a34a !important;
      color: #ffffff !important;
    }

    .add-set-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 0.75rem;
      padding: 3px 8px;
      cursor: pointer;
    }

    /* Warm-up vs working vs top set */
    .set-row-warmup td {
      opacity: 0.6;
    }

    .set-row-working {
      background-color: rgba(22, 163, 74, 0.08);
    }

    body.dark-theme .set-row-working {
      background-color: rgba(22, 163, 74, 0.18);
    }

    .set-row-top {
      background-color: rgba(234, 179, 8, 0.12);
      border-left: 3px solid #eab308;
    }

    body.dark-theme .set-row-top {
      background-color: rgba(234, 179, 8, 0.22);
    }

    /* PR history block */
    .pr-history {
      font-size: 0.75rem;
      margin-top: 6px;
    }

    .pr-history summary {
      cursor: pointer;
      list-style: none;
    }

    .pr-history summary::marker {
      display: none;
    }

    .pr-history summary::before {
      content: "‚ñ∂";
      display: inline-block;
      margin-right: 4px;
      font-size: 0.7rem;
      transform: translateY(-1px);
    }

    .pr-history[open] summary::before {
      content: "‚ñº";
    }

    .pr-history-body {
      margin-top: 4px;
      color: var(--muted);
      max-height: 120px;
      overflow-y: auto;
    }

    .pr-history-item {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 2px;
    }

    .pr-history-item span {
      font-size: 0.7rem;
    }

    /* Bottom rest timer bar */
    .rest-timer-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--card);
      border-top: 1px solid var(--border);
      padding: 8px 16px 10px;
      font-size: 0.8rem;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      z-index: 30;
    }

    .rest-timer-bar.active {
      display: flex;
    }

    .rest-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .rest-ex-name {
      font-weight: 600;
    }

    .rest-time {
      font-variant-numeric: tabular-nums;
    }

    .rest-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .rest-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: var(--bg);
      font-size: 0.7rem;
      padding: 3px 6px;
      cursor: pointer;
    }

    /* Progress tab */
    .progress-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.85rem;
    }

    .progress-card {
      background-color: var(--card);
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
    }

    .progress-card-header {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .muted {
      color: var(--muted);
    }

    /* Settings */
    .settings-group {
      margin-bottom: 16px;
    }

    .settings-group h3 {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .settings-group p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    /* Toast (bottom-right) */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #111;
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }

    body.dark-theme .toast {
      background: #222;
    }

    .toast.show {
      opacity: 1;
    }

    /* Add Exercise button */
    .add-exercise-global {
      margin-top: 8px;
      width: 100%;
      text-align: center;
      font-size: 0.8rem;
      border-style: dashed;
    }

    @media (max-width: 600px) {
      .summary-bar.active {
        align-items: flex-start;
      }
      .summary-left {
        flex-direction: column;
        gap: 4px;
      }
      .summary-actions {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="top-nav">
        <div class="nav-tabs">
          <div class="nav-tab active" data-tab="workout">WORKOUT</div>
          <div class="nav-tab" data-tab="calculators">CALCULATORS</div>
          <div class="nav-tab" data-tab="progress">PROGRESS</div>
          <div class="nav-tab" data-tab="settings">SETTINGS</div>
        </div>
        <button class="theme-toggle-btn" id="themeToggle" aria-label="Toggle theme">üåô</button>
      </div>
      <div class="summary-bar" id="summaryBar">
        <div class="summary-left">
          <div class="summary-label">WORKOUT SUMMARY</div>
          <div class="summary-stat">Duration: <span id="summaryDuration">00:00</span></div>
          <div class="summary-stat">Volume: <span id="summaryVolume">0 kg</span></div>
          <div class="summary-stat">Sets: <span id="summarySets">0/0</span></div>
        </div>
        <div class="summary-actions">
          <button class="btn btn-sm" id="pauseWorkoutBtn">‚è∏ Pause</button>
          <button class="btn btn-sm btn-danger" id="cancelWorkoutBtn">‚úñ Cancel</button>
          <button class="btn btn-sm btn-primary" id="saveWorkoutBtn">üíæ Save</button>
        </div>
      </div>
    </header>

    <main>
      <!-- WORKOUT TAB -->
      <section class="main-tab active" id="tab-workout">
        <div class="start-workout-wrapper" id="startWorkoutWrapper">
          <button class="btn btn-primary" id="startWorkoutBtn">‚ñ∂ START WORKOUT</button>
        </div>

        <div class="day-tabs">
          <button class="day-tab active" data-day="day1">Day 1 ‚Äì Push</button>
          <button class="day-tab" data-day="day2">Day 2 ‚Äì Legs</button>
          <button class="day-tab" data-day="day3">Day 3 ‚Äì Pull</button>
        </div>

        <div id="day1" class="day-panel active">
          <div class="exercise-list" data-day="day1"></div>
          <button class="btn add-exercise-global" data-day="day1">+ Add Exercise</button>
        </div>
        <div id="day2" class="day-panel">
          <div class="exercise-list" data-day="day2"></div>
          <button class="btn add-exercise-global" data-day="day2">+ Add Exercise</button>
        </div>
        <div id="day3" class="day-panel">
          <div class="exercise-list" data-day="day3"></div>
          <button class="btn add-exercise-global" data-day="day3">+ Add Exercise</button>
        </div>
      </section>

      <!-- CALCULATORS TAB (placeholder for now) -->
      <section class="main-tab" id="tab-calculators">
        <h2 style="font-size:1rem;margin-bottom:8px;">Calculators</h2>
        <p class="muted" style="font-size:0.8rem;margin-bottom:10px;">
          Warm-up, 1RM, working weight and standards calculators will live here.
        </p>
        <ul style="font-size:0.85rem;padding-left:18px;">
          <li>1RM Calculator</li>
          <li>Warm-up Set Calculator (Olympus / Mentzer / Soviet)</li>
          <li>Working Weight from % of 1RM</li>
          <li>Plate Math (per side)</li>
          <li>Strength Standards (Good / Great / Godlike)</li>
        </ul>
      </section>

      <!-- PROGRESS TAB -->
      <section class="main-tab" id="tab-progress">
        <h2 style="font-size:1rem;margin-bottom:8px;">Progress</h2>
        <p class="muted" style="font-size:0.8rem;margin-bottom:10px;">
          Recent workouts saved from this prototype (local only).
        </p>
        <div class="progress-list" id="progressList"></div>
      </section>

      <!-- SETTINGS TAB -->
      <section class="main-tab" id="tab-settings">
        <h2 style="font-size:1rem;margin-bottom:8px;">Settings</h2>
        <div class="settings-group">
          <h3>Theme</h3>
          <p>Use the icon in the top navigation to switch between light and dark mode.</p>
        </div>
        <div class="settings-group">
          <h3>Prototype Notice</h3>
          <p>This is a front-end prototype using localStorage only. No real backend or login is wired yet.</p>
        </div>
      </section>
    </main>

    <!-- Rest timer bar -->
    <div class="rest-timer-bar" id="restTimerBar">
      <div class="rest-main">
        <div class="rest-ex-name" id="restExerciseName">RESTING ‚Äî</div>
        <div class="rest-time" id="restTimeText">00:00 remaining</div>
      </div>
      <div class="rest-controls">
        <button class="rest-btn" data-delta="-30">-30s</button>
        <button class="rest-btn" data-delta="-15">-15s</button>
        <button class="rest-btn" data-delta="15">+15s</button>
        <button class="rest-btn" data-delta="30">+30s</button>
      </div>
    </div>
  </div>

  <script>
    /********************
     * THEME TOGGLE
     ********************/
    const bodyEl = document.body;
    const themeToggleBtn = document.getElementById('themeToggle');

    function applyTheme(theme) {
      if (theme === 'dark') {
        bodyEl.classList.add('dark-theme');
        themeToggleBtn.textContent = '‚òÄ';
      } else {
        bodyEl.classList.remove('dark-theme');
        themeToggleBtn.textContent = 'üåô';
      }
      localStorage.setItem('theme', theme);
    }

    const storedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(storedTheme);

    themeToggleBtn.addEventListener('click', () => {
      const current = bodyEl.classList.contains('dark-theme') ? 'dark' : 'light';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    });

    /********************
     * TOASTS
     ********************/
    function showToast(msg) {
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = msg;
      document.body.appendChild(t);
      requestAnimationFrame(() => t.classList.add("show"));
      setTimeout(() => {
        t.classList.remove("show");
        setTimeout(() => t.remove(), 300);
      }, 2500);
    }

    /********************
     * MAIN TABS
     ********************/
    const navTabs = document.querySelectorAll('.nav-tab');
    const mainTabs = document.querySelectorAll('.main-tab');

    navTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.tab;
        navTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        mainTabs.forEach(section => {
          section.classList.toggle('active', section.id === 'tab-' + target);
        });
      });
    });

    /********************
     * DAY TABS
     ********************/
    const dayTabs = document.querySelectorAll('.day-tab');
    const dayPanels = document.querySelectorAll('.day-panel');

    dayTabs.forEach(btn => {
      btn.addEventListener('click', () => {
        const day = btn.dataset.day;
        dayTabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        dayPanels.forEach(p => {
          p.classList.toggle('active', p.id === day);
        });
        workoutState.currentDay = day;
      });
    });

    /********************
     * EXERCISE DATA (DEFAULT OLYMPUS)
     ********************/
    const defaultDayExercises = {
      day1: [
        'Incline Bench Press',
        'Weighted Dips',
        'Overhead Press',
        'Lateral Raises',
        'Triceps Rope Pushdown',
        'Skull Crusher'
      ],
      day2: [
        'Squats',
        'Romanian Deadlift',
        'Hamstring Curl Machine',
        'Leg Press',
        'Hack Squat',
        'Calf Raises'
      ],
      day3: [
        'Weighted Pull-Ups',
        'Barbell Rows',
        'Rear Delt Flys',
        'Shrugs',
        'Barbell Biceps Curl'
      ]
    };

    function slugify(name) {
      return name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
    }

    /********************
     * ROUTINE PERSISTENCE (per day)
     ********************/
    function getRoutine(dayKey) {
      const key = "routine_" + dayKey;
      const stored = localStorage.getItem(key);
      if (stored) {
        return JSON.parse(stored);
      }
      // fallback: default exercises
      return defaultDayExercises[dayKey].map(name => ({ type: 'exercise', name }));
    }

    function saveRoutine(dayKey) {
      const listEl = document.querySelector(`.exercise-list[data-day="${dayKey}"]`);
      if (!listEl) return;
      const routine = [];
      listEl.querySelectorAll('.exercise-card').forEach(card => {
        routine.push({
          type: 'exercise',      // v1: only single exercises; superset can be refined later
          name: card.dataset.exerciseName || ''
        });
      });
      localStorage.setItem("routine_" + dayKey, JSON.stringify(routine));
    }

    /********************
     * RUNTIME STATE
     ********************/
    let workoutState = {
      started: false,
      paused: false,
      cancelled: false,
      startTime: null,
      pauseAccum: 0,
      pauseStart: null,
      totalVolume: 0,
      totalSetsCompleted: 0,
      totalSetsPlanned: 0,
      currentDay: 'day1'
    };

    const summaryBar = document.getElementById('summaryBar');
    const summaryDuration = document.getElementById('summaryDuration');
    const summaryVolume = document.getElementById('summaryVolume');
    const summarySets = document.getElementById('summarySets');
    const startWorkoutWrapper = document.getElementById('startWorkoutWrapper');
    const startWorkoutBtn = document.getElementById('startWorkoutBtn');
    const pauseWorkoutBtn = document.getElementById('pauseWorkoutBtn');
    const cancelWorkoutBtn = document.getElementById('cancelWorkoutBtn');
    const saveWorkoutBtn = document.getElementById('saveWorkoutBtn');

    let durationTimer = null;

    function formatTimeFromSeconds(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function updateSummary() {
      if (!workoutState.started || workoutState.cancelled || !workoutState.startTime) {
        summaryDuration.textContent = '00:00';
      } else {
        let now = Date.now();
        let elapsed = Math.floor((now - workoutState.startTime) / 1000);
        if (workoutState.paused && workoutState.pauseStart) {
          const pausedSoFar = Math.floor((now - workoutState.pauseStart) / 1000);
          elapsed -= pausedSoFar;
        }
        elapsed -= workoutState.pauseAccum;
        if (elapsed < 0) elapsed = 0;
        summaryDuration.textContent = formatTimeFromSeconds(elapsed);
      }
      summaryVolume.textContent = `${workoutState.totalVolume.toFixed(0)} kg`;
      summarySets.textContent = `${workoutState.totalSetsCompleted}/${workoutState.totalSetsPlanned}`;
    }

    function startDurationTimer() {
      if (durationTimer) clearInterval(durationTimer);
      durationTimer = setInterval(updateSummary, 1000);
    }

    function resetWorkoutState() {
      workoutState = {
        started: false,
        paused: false,
        cancelled: false,
        startTime: null,
        pauseAccum: 0,
        pauseStart: null,
        totalVolume: 0,
        totalSetsCompleted: 0,
        totalSetsPlanned: workoutState.totalSetsPlanned,
        currentDay: workoutState.currentDay
      };
      updateSummary();
      summaryBar.classList.remove('active');
      startWorkoutWrapper.style.display = 'block';
      if (durationTimer) clearInterval(durationTimer);
    }

    /********************
     * START / PAUSE / CANCEL / SAVE
     ********************/
    startWorkoutBtn.addEventListener('click', () => {
      workoutState.started = true;
      workoutState.cancelled = false;
      workoutState.paused = false;
      workoutState.startTime = Date.now();
      workoutState.pauseAccum = 0;
      workoutState.pauseStart = null;
      workoutState.totalVolume = 0;
      workoutState.totalSetsCompleted = 0;
      calculateTotalPlannedSets();
      startWorkoutWrapper.style.display = 'none';
      summaryBar.classList.add('active');
      updateSummary();
      startDurationTimer();
    });

    pauseWorkoutBtn.addEventListener('click', () => {
      if (!workoutState.started || workoutState.cancelled) return;
      if (workoutState.paused) {
        workoutState.paused = false;
        if (workoutState.pauseStart) {
          const now = Date.now();
          workoutState.pauseAccum += Math.floor((now - workoutState.pauseStart) / 1000);
          workoutState.pauseStart = null;
        }
        pauseWorkoutBtn.textContent = '‚è∏ Pause';
      } else {
        workoutState.paused = true;
        workoutState.pauseStart = Date.now();
        pauseWorkoutBtn.textContent = '‚ñ∂ Resume';
      }
      updateSummary();
    });

    cancelWorkoutBtn.addEventListener('click', () => {
      if (!workoutState.started) return;
      const confirmed = window.confirm('Cancel this workout? Progress will not be saved.');
      if (!confirmed) return;
      workoutState.cancelled = true;
      resetWorkoutState();
      resetCompletedSetsUI();
      clearRestTimer();
    });

    saveWorkoutBtn.addEventListener('click', () => {
      if (!workoutState.started || workoutState.cancelled) return;
      let now = Date.now();
      let elapsed = Math.floor((now - workoutState.startTime) / 1000) - workoutState.pauseAccum;
      if (elapsed < 0) elapsed = 0;

      const workoutRecord = {
        id: Date.now(),
        date: new Date().toISOString(),
        day: workoutState.currentDay,
        durationSeconds: elapsed,
        totalVolume: workoutState.totalVolume,
        setsCompleted: workoutState.totalSetsCompleted,
        setsPlanned: workoutState.totalSetsPlanned
      };

      const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
      history.unshift(workoutRecord);
      localStorage.setItem('workoutHistory', JSON.stringify(history));

      alert('Workout saved (prototype, localStorage only).');

      resetWorkoutState();
      resetCompletedSetsUI();
      clearRestTimer();
      renderProgressList();
    });

    function resetCompletedSetsUI() {
      document.querySelectorAll('.sets-table tr.completed').forEach(tr => {
        tr.classList.remove('completed', 'set-row-working', 'set-row-top');
      });
      document.querySelectorAll('.set-done-btn.done').forEach(btn => {
        btn.classList.remove('done');
      });
      workoutState.totalVolume = 0;
      workoutState.totalSetsCompleted = 0;
      updateAllExerciseStats();
    }

    /********************
     * PR STORAGE HELPERS
     ********************/
    function getPR(exId) {
      const key = "PR_" + exId;
      const stored = localStorage.getItem(key);
      if (!stored) {
        return { best1RM: 0, bestReps: 0, bestVolume: 0, peakLoad: 0 };
      }
      return JSON.parse(stored);
    }

    function savePR(exId, prObj) {
      localStorage.setItem("PR_" + exId, JSON.stringify(prObj));
    }

    function addPRHistory(exId, type, value) {
      const key = "PRHIST_" + exId;
      let arr = JSON.parse(localStorage.getItem(key) || "[]");
      arr.unshift({
        date: new Date().toISOString(),
        type: type,
        value: value
      });
      localStorage.setItem(key, JSON.stringify(arr));
    }

    function getPRHistory(exId) {
      const key = "PRHIST_" + exId;
      return JSON.parse(localStorage.getItem(key) || "[]");
    }

    function renderExercisePRHistory(exId, card) {
      const container = card.querySelector('.pr-history-body');
      if (!container) return;
      container.innerHTML = '';
      const hist = getPRHistory(exId);
      if (!hist.length) {
        container.innerHTML = '<div class="muted" style="font-size:0.7rem;">No PRs yet.</div>';
        return;
      }
      hist.forEach(item => {
        const d = new Date(item.date);
        const row = document.createElement('div');
        row.className = 'pr-history-item';
        row.innerHTML = `
          <span>${d.toLocaleDateString()}</span>
          <span>${item.type}</span>
          <span>${item.value}</span>
        `;
        container.appendChild(row);
      });
    }

    function checkAndApplyPRs(exId, exerciseName, weight, repsRaw, est1RM, setVolume, row, card) {
      let pr = getPR(exId);
      let newPRs = [];

      if (est1RM > (pr.best1RM || 0)) {
        pr.best1RM = est1RM;
        newPRs.push("1RM PR");
      }
      if (repsRaw > (pr.bestReps || 0)) {
        pr.bestReps = repsRaw;
        newPRs.push("Rep PR");
      }
      if (setVolume > (pr.bestVolume || 0)) {
        pr.bestVolume = setVolume;
        newPRs.push("Volume PR");
      }
      if (weight > (pr.peakLoad || 0)) {
        pr.peakLoad = weight;
        newPRs.push("Peak Load PR");
      }

      if (newPRs.length > 0) {
        savePR(exId, pr);

        const lastTd = row.querySelector('td:last-child');
        const badgeWrap = document.createElement("span");
        badgeWrap.style.marginLeft = "6px";
        badgeWrap.style.color = "#f97316";
        badgeWrap.style.fontSize = "0.7rem";
        badgeWrap.textContent = newPRs.join(" + ");
        lastTd.appendChild(badgeWrap);

        newPRs.forEach(type => {
          showToast("üî• NEW " + type + "!");
          let val;
          if (type === "1RM PR") val = est1RM.toFixed(1) + " kg";
          else if (type === "Rep PR") val = repsRaw + " reps";
          else if (type === "Volume PR") val = setVolume.toFixed(0) + " vol";
          else if (type === "Peak Load PR") val = weight + " kg";
          addPRHistory(exId, type, val);
        });

        renderExercisePRHistory(exId, card);
      }
    }

    /********************
     * EXERCISE CARDS
     ********************/
    function createExerciseCard(dayKey, exerciseName) {
      const listEl = document.querySelector(`.exercise-list[data-day="${dayKey}"]`);
      const card = document.createElement('div');
      const exId = slugify(exerciseName);
      card.className = 'exercise-card';
      card.setAttribute('draggable', 'true');
      card.dataset.exerciseId = exId;
      card.dataset.exerciseName = exerciseName;

      card.innerHTML = `
        <div class="exercise-header">
          <div class="exercise-title">
            <span class="collapse-icon">‚ñº</span>
            <span class="exercise-name-text">${exerciseName}</span>
          </div>
          <div class="exercise-actions">
            <button class="exercise-menu-btn" title="Edit">‚ãØ</button>
            <span class="drag-handle">‚ãÆ‚ãÆ</span>
          </div>
        </div>
        <div class="exercise-stats">
          <span class="stat-volume">Volume: <strong data-ex-stat="volume">0</strong> kg</span>
          <span class="stat-1rm">Est. 1RM: <strong data-ex-stat="onerm">-</strong></span>
        </div>
        <div class="exercise-body">
          <table class="sets-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Weight</th>
                <th>Reps</th>
                <th>Done</th>
              </tr>
            </thead>
            <tbody>
              <tr data-set-index="1">
                <td>1</td>
                <td><input type="number" class="weight-input" min="0" step="0.5" /></td>
                <td><input type="number" class="reps-input" min="0" step="1" /></td>
                <td><button class="set-done-btn">‚úî</button></td>
              </tr>
              <tr data-set-index="2">
                <td>2</td>
                <td><input type="number" class="weight-input" min="0" step="0.5" /></td>
                <td><input type="number" class="reps-input" min="0" step="1" /></td>
                <td><button class="set-done-btn">‚úî</button></td>
              </tr>
            </tbody>
          </table>
          <button class="add-set-btn">+ Add Set</button>
          <details class="pr-history">
            <summary>PR History</summary>
            <div class="pr-history-body"></div>
          </details>
        </div>
      `;
      listEl.appendChild(card);

      const tbody = card.querySelector('tbody');
      tbody.addEventListener('input', () => {
        updateExerciseStats(card);
        updateSummary();
      });

      tbody.addEventListener('click', e => {
        if (e.target.classList.contains('set-done-btn')) {
          handleSetDoneClick(card, e.target);
        }
      });

      const addSetBtn = card.querySelector('.add-set-btn');
      addSetBtn.addEventListener('click', () => {
        addNewSetRow(card);
      });

      // Collapsible title
      const titleEl = card.querySelector('.exercise-title');
      titleEl.addEventListener('click', (e) => {
        // Ignore clicks on menu / drag
        if (e.target.classList.contains('exercise-menu-btn') || e.target.classList.contains('drag-handle')) return;
        card.classList.toggle('collapsed');
        const icon = card.querySelector('.collapse-icon');
        icon.textContent = card.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
      });

      // Menu button
      const menuBtn = card.querySelector('.exercise-menu-btn');
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openExerciseMenu(card);
      });

      renderExercisePRHistory(exId, card);

      return card;
    }

    function addNewSetRow(card) {
      const tbody = card.querySelector('tbody');
      const rowCount = tbody.querySelectorAll('tr').length;
      const tr = document.createElement('tr');
      tr.dataset.setIndex = String(rowCount + 1);
      tr.innerHTML = `
        <td>${rowCount + 1}</td>
        <td><input type="number" class="weight-input" min="0" step="0.5" /></td>
        <td><input type="number" class="reps-input" min="0" step="1" /></td>
        <td><button class="set-done-btn">‚úî</button></td>
      `;
      tbody.appendChild(tr);
      calculateTotalPlannedSets();
    }

    function calculateTotalPlannedSets() {
      const rows = document.querySelectorAll('.sets-table tbody tr');
      workoutState.totalSetsPlanned = rows.length;
      updateSummary();
    }

    function updateExerciseStats(card) {
      const rows = card.querySelectorAll('tbody tr');
      let volume = 0;
      let best1RM = null;
      let best1RM_row = null;

      rows.forEach(row => {
        const done = row.classList.contains('completed');

        if (done) {
          row.classList.add('set-row-working');
          row.classList.remove('set-row-warmup');
        } else {
          row.classList.remove('set-row-working', 'set-row-top');
          row.classList.add('set-row-warmup');
        }

        if (!done) return;

        const weight = parseFloat(row.querySelector('.weight-input')?.value || '0');
        const repsRaw = parseInt(row.querySelector('.reps-input')?.value || '0', 10);

        if (weight > 0 && repsRaw > 0) {
          volume += weight * repsRaw;

          const reps = Math.min(repsRaw, 10);
          const est1RM = weight * (1 + reps / 30);

          if (best1RM === null || est1RM > best1RM) {
            best1RM = est1RM;
            best1RM_row = row;
          }
        }
      });

      rows.forEach(r => r.classList.remove('set-row-top'));
      if (best1RM_row) {
        best1RM_row.classList.add('set-row-top');
      }

      const vEl = card.querySelector('[data-ex-stat="volume"]');
      const rEl = card.querySelector('[data-ex-stat="onerm"]');
      vEl.textContent = volume.toFixed(0);
      rEl.textContent = best1RM ? best1RM.toFixed(1) + ' kg' : '-';

      recomputeTotalVolume();
    }

    function updateAllExerciseStats() {
      document.querySelectorAll('.exercise-card').forEach(card => updateExerciseStats(card));
      recomputeTotalVolume();
    }

    function recomputeTotalVolume() {
      let total = 0;
      document.querySelectorAll('.exercise-card').forEach(card => {
        const v = parseFloat(card.querySelector('[data-ex-stat="volume"]').textContent || '0');
        total += v;
      });
      workoutState.totalVolume = total;
      updateSummary();
    }

    function handleSetDoneClick(card, btn) {
      const row = btn.closest('tr');
      const weight = parseFloat(row.querySelector('.weight-input')?.value || '0');
      const repsRaw = parseInt(row.querySelector('.reps-input')?.value || '0', 10);
      if (!weight || !repsRaw) {
        alert('Enter weight and reps before marking a set as done.');
        return;
      }

      if (!btn.classList.contains('done')) {
        btn.classList.add('done');
        row.classList.add('completed');
        workoutState.totalSetsCompleted += 1;

        const exId = card.dataset.exerciseId;
        const exerciseName = card.dataset.exerciseName;
        const repsFor1RM = Math.min(repsRaw, 10);
        const setVolume = weight * repsRaw;
        const est1RM = weight * (1 + repsFor1RM / 30);

        checkAndApplyPRs(exId, exerciseName, weight, repsRaw, est1RM, setVolume, row, card);

      } else {
        btn.classList.remove('done');
        row.classList.remove('completed', 'set-row-working', 'set-row-top');
        workoutState.totalSetsCompleted = Math.max(workoutState.totalSetsCompleted - 1, 0);
      }

      updateExerciseStats(card);
      updateSummary();

      if (btn.classList.contains('done')) {
        const exName = card.dataset.exerciseName;
        startRestTimerForExercise(card.dataset.exerciseId, exName);
      }
    }

    /********************
     * REST TIMER
     ********************/
    const restBar = document.getElementById('restTimerBar');
    const restNameEl = document.getElementById('restExerciseName');
    const restTimeText = document.getElementById('restTimeText');
    const restButtons = document.querySelectorAll('.rest-btn');

    let restState = {
      activeExerciseId: null,
      remaining: 0,
      timerId: null
    };
    const restDefaults = {};

    function startRestTimerForExercise(exId, exName) {
      const defaultSec = restDefaults[exId] || 90;
      restState.activeExerciseId = exId;
      restState.remaining = defaultSec;
      restNameEl.textContent = 'RESTING ‚Äî ' + exName;
      updateRestDisplay();
      restBar.classList.add('active');

      if (restState.timerId) clearInterval(restState.timerId);
      restState.timerId = setInterval(() => {
        if (restState.remaining > 0) {
          restState.remaining -= 1;
          updateRestDisplay();
        } else {
          updateRestDisplay();
        }
      }, 1000);
    }

    function updateRestDisplay() {
      const sec = Math.max(0, restState.remaining);
      restTimeText.textContent = `${formatTimeFromSeconds(sec)} remaining`;
    }

    function clearRestTimer() {
      if (restState.timerId) clearInterval(restState.timerId);
      restState = {
        activeExerciseId: null,
        remaining: 0,
        timerId: null
      };
      restBar.classList.remove('active');
    }

    restButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const delta = parseInt(btn.dataset.delta, 10);
        restState.remaining = Math.max(0, restState.remaining + delta);
        updateRestDisplay();
      });
    });

    /********************
     * DRAG & DROP
     ********************/
    document.querySelectorAll('.exercise-list').forEach(list => {
      let draggedCard = null;

      list.addEventListener('dragstart', e => {
        const card = e.target.closest('.exercise-card');
        if (!card) return;
        draggedCard = card;
        card.classList.add('dragging');
      });

      list.addEventListener('dragend', e => {
        const card = e.target.closest('.exercise-card');
        if (!card) return;
        card.classList.remove('dragging');
        draggedCard = null;
        saveExerciseOrder(list.dataset.day);
        saveRoutine(list.dataset.day);
      });

      list.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        if (!draggedCard) return;
        if (afterElement == null) {
          list.appendChild(draggedCard);
        } else {
          list.insertBefore(draggedCard, afterElement);
        }
      });
    });

    function getDragAfterElement(container, y) {
      const cards = [...container.querySelectorAll('.exercise-card:not(.dragging)')];
      return cards.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY, element: null }
      ).element;
    }

    function saveExerciseOrder(dayKey) {
      const listEl = document.querySelector(`.exercise-list[data-day="${dayKey}"]`);
      if (!listEl) return;
      const order = [...listEl.querySelectorAll('.exercise-card')].map(card => card.dataset.exerciseName);
      localStorage.setItem('exerciseOrder_' + dayKey, JSON.stringify(order));
    }

    function loadExerciseOrder(dayKey) {
      const stored = localStorage.getItem('exerciseOrder_' + dayKey);
      if (!stored) return;
      const order = JSON.parse(stored);
      const listEl = document.querySelector(`.exercise-list[data-day="${dayKey}"]`);
      const cards = {};
      [...listEl.querySelectorAll('.exercise-card')].forEach(card => {
        cards[card.dataset.exerciseName] = card;
      });
      order.forEach(name => {
        if (cards[name]) listEl.appendChild(cards[name]);
      });
    }

    /********************
     * EXERCISE MENU (Rename / Replace / Delete / Superset v1)
     ********************/
    function openExerciseMenu(card) {
      const exName = card.dataset.exerciseName;
      const action = prompt(
        `Edit "${exName}"\n\nChoose an option:\n1 = Rename\n2 = Replace\n3 = Delete\n4 = Add to Superset (v1: combine names)`,
        "1"
      );
      if (!action) return;
      const dayKey = card.closest('.exercise-list').dataset.day;

      if (action === "1") {
        const newName = prompt("New name for this exercise:", exName);
        if (newName && newName.trim()) {
          const trimmed = newName.trim();
          card.dataset.exerciseName = trimmed;
          card.dataset.exerciseId = slugify(trimmed);
          card.querySelector('.exercise-name-text').textContent = trimmed;
          saveRoutine(dayKey);
        }
      } else if (action === "2") {
        const allNames = getAllExerciseNames(dayKey);
        const listStr = allNames.join(", ");
        const repName = prompt(
          `Type a new exercise name or choose from:\n${listStr}`,
          exName
        );
        if (repName && repName.trim()) {
          const trimmed = repName.trim();
          card.dataset.exerciseName = trimmed;
          card.dataset.exerciseId = slugify(trimmed);
          card.querySelector('.exercise-name-text').textContent = trimmed;
          saveRoutine(dayKey);
        }
      } else if (action === "3") {
        const ok = confirm(`Delete "${exName}" from this routine?`);
        if (ok) {
          card.remove();
          calculateTotalPlannedSets();
          saveRoutine(dayKey);
          updateAllExerciseStats();
        }
      } else if (action === "4") {
        addToSupersetSimple(card);
        saveRoutine(dayKey);
      }
    }

    function getAllExerciseNames(dayKey) {
      const listEl = document.querySelector(`.exercise-list[data-day="${dayKey}"]`);
      return [...listEl.querySelectorAll('.exercise-card')].map(c => c.dataset.exerciseName);
    }

    // Superset v1 (simple): combine this exercise + another into a single card name
    function addToSupersetSimple(card) {
      const dayKey = card.closest('.exercise-list').dataset.day;
      const listEl = document.querySelector(`.exercise-list[data-day="${dayKey}"]`);
      const cards = [...listEl.querySelectorAll('.exercise-card')];
      if (cards.length < 2) {
        alert("You need at least two exercises in this day to create a superset.");
        return;
      }

      const currentName = card.dataset.exerciseName;
      const others = cards
        .filter(c => c !== card)
        .map(c => c.dataset.exerciseName);
      if (!others.length) {
        alert("No other exercise to pair with.");
        return;
      }

      const choice = prompt(
        `Create superset with "${currentName}".\nChoose another exercise by typing its name:\n` +
        others.join(", ")
      );
      if (!choice) return;

      const selectedName = choice.trim();
      const partnerCard = cards.find(c => c.dataset.exerciseName === selectedName);
      if (!partnerCard) {
        alert("Exercise not found. Make sure you typed the name exactly.");
        return;
      }

      // v1 behavior: merge into a single combined card (name only)
      const combinedName = `Superset: ${currentName} + ${selectedName}`;
      card.dataset.exerciseName = combinedName;
      card.dataset.exerciseId = slugify(combinedName);
      card.querySelector('.exercise-name-text').textContent = combinedName;

      // remove the partner card (user can create their own superset structure with combined sets)
      partnerCard.remove();

      calculateTotalPlannedSets();
      updateAllExerciseStats();
      showToast("Superset created (v1 ‚Äì combined card).");
    }

    /********************
     * PROGRESS TAB
     ********************/
    const progressList = document.getElementById('progressList');

    function renderProgressList() {
      progressList.innerHTML = '';
      const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
      if (!history.length) {
        progressList.innerHTML = '<p class="muted">No workouts saved yet.</p>';
        return;
      }

      history.forEach(w => {
        const card = document.createElement('div');
        card.className = 'progress-card';
        const d = new Date(w.date);
        card.innerHTML = `
          <div class="progress-card-header">
            <span>${d.toLocaleDateString()} ‚Äì ${w.day.toUpperCase()}</span>
            <span class="muted">${formatTimeFromSeconds(w.durationSeconds)}</span>
          </div>
          <div>Volume: <strong>${w.totalVolume.toFixed(0)} kg</strong></div>
          <div class="muted" style="margin-top:2px;font-size:0.8rem;">Sets: ${w.setsCompleted}/${w.setsPlanned}</div>
        `;
        progressList.appendChild(card);
      });
    }

    /********************
     * ADD EXERCISE BUTTON
     ********************/
    document.querySelectorAll('.add-exercise-global').forEach(btn => {
      btn.addEventListener('click', () => {
        const dayKey = btn.dataset.day;
        const name = prompt("Name of the new exercise:");
        if (!name || !name.trim()) return;
        const trimmed = name.trim();
        createExerciseCard(dayKey, trimmed);
        calculateTotalPlannedSets();
        updateAllExerciseStats();
        saveRoutine(dayKey);
      });
    });

    /********************
     * INITIALIZATION
     ********************/
    function initExercises() {
      Object.keys(defaultDayExercises).forEach(dayKey => {
        const routine = getRoutine(dayKey); // either saved or default
        routine.forEach(block => {
          if (block.type === 'exercise') {
            createExerciseCard(dayKey, block.name);
          }
        });
      });
      calculateTotalPlannedSets();
      updateAllExerciseStats();
      Object.keys(defaultDayExercises).forEach(dayKey => loadExerciseOrder(dayKey));
    }

    initExercises();
    renderProgressList();
    updateSummary();
  </script>
</body>
</html>